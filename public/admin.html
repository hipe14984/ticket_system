<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administración</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link id="theme-stylesheet" rel="stylesheet" href="light-theme.css">
  <style>
    .theme-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center mb-4">Panel de Administración</h1>

    <button class="btn btn-secondary theme-toggle">Cambiar Tema</button>

    <div class="card p-4 mb-4">
      <h2>Eventos Existentes</h2>
      <ul id="event-list" class="list-group"></ul>
    </div>

    <form id="create-event-form" class="card p-4">
      <h2>Crear o Modificar Evento</h2>
      <input type="hidden" id="event_id">

      <div class="mb-3">
        <label for="name" class="form-label">Nombre del Evento:</label>
        <input type="text" id="name" name="name" class="form-control" required>
      </div>

      <div class="mb-3">
        <label for="event_date" class="form-label">Fecha del Evento:</label>
        <input type="date" id="event_date" name="event_date" class="form-control" required>
      </div>

      <div class="mb-3">
        <label for="event_type" class="form-label">Tipo de Evento:</label>
        <select id="event_type" name="event_type" class="form-select" required>
          <option value="regular">Temporada Regular</option>
          <option value="postseason">Postemporada</option>
          <option value="final">Final</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="seating_chart_id" class="form-label">Seating Chart:</label>
        <select id="seating_chart_id" class="form-select" required></select>
      </div>

      <button type="submit" class="btn btn-primary w-100">Guardar Evento</button>
    </form>
  </div>

  <script>
    async function fetchEvents() {
      const response = await fetch('/events');
      const events = await response.json();

      const eventList = document.getElementById('event-list');
      eventList.innerHTML = '';

      events.forEach(event => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <span>${event.name} - ${event.event_date} (${event.event_type})</span>
          <div>
            <button class="btn btn-sm btn-warning me-2" onclick="editEvent(${event.id}, '${event.name}', '${event.event_date}', '${event.event_type}', ${event.seating_chart_id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="deleteEvent(${event.id})">Eliminar</button>
          </div>
        `;
        eventList.appendChild(li);
      });
    }

    async function fetchSeatingCharts() {
      const response = await fetch('/seating-charts');
      const charts = await response.json();

      const chartSelect = document.getElementById('seating_chart_id');
      chartSelect.innerHTML = '';

      charts.forEach(chart => {
        const option = document.createElement('option');
        option.value = chart.id;
        option.textContent = chart.name;
        chartSelect.appendChild(option);
      });
    }

    document.getElementById('create-event-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const event_id = document.getElementById('event_id').value;
      const name = document.getElementById('name').value;
      const event_date = document.getElementById('event_date').value;
      const event_type = document.getElementById('event_type').value;
      const seating_chart_id = document.getElementById('seating_chart_id').value;

      const method = event_id ? 'PUT' : 'POST';
      const url = event_id ? `/admin/events/${event_id}` : '/admin/events';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name, event_date, event_type, seating_chart_id }),
      });

      const result = await response.json();
      alert(result.message);
      fetchEvents();
      document.getElementById('create-event-form').reset();
    });

    async function deleteEvent(id) {
      if (!confirm('¿Estás seguro de que deseas eliminar este evento?')) return;

      const response = await fetch(`/admin/events/${id}`, {
        method: 'DELETE',
      });

      const result = await response.json();
      alert(result.message);
      fetchEvents();
    }

    function editEvent(id, name, date, type, chartId) {
      document.getElementById('event_id').value = id;
      document.getElementById('name').value = name;
      document.getElementById('event_date').value = date;
      document.getElementById('event_type').value = type;
      document.getElementById('seating_chart_id').value = chartId;
    }

    document.querySelector('.theme-toggle').addEventListener('click', () => {
      const themeStylesheet = document.getElementById('theme-stylesheet');
      const currentTheme = themeStylesheet.getAttribute('href');
      themeStylesheet.setAttribute('href', currentTheme === 'light-theme.css' ? 'dark-theme.css' : 'light-theme.css');
    });

    fetchEvents();
    fetchSeatingCharts();
  </script>
</body>
</html>